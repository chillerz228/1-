Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведния)

	//Определить, нужно ли обнолять дату в движениях.
	ОбновитьДатуДвижения = ЭтоНовый() Или Движения.ОстаткиМатериалов.Модифицированность();
	Если не ОбновитьДатуДвижения Тогда
		
		//Проверить, что дата изменилась.
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("ТекущийДокумент", Ссылка);
		Запрос.Текст = 
		"ВЫБРАТЬ
		|		 Дата
		|ИЗ
		|		 Документ.ВводНачальныхОстатковНоменклатуры
		|ГДЕ
		| Ссылка = &ТекущийДокумент";
		
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		ОбновитьДатуДвижения = Выборка.Дата > Дата;
	КонецЕсли;
	
	//Установить всем новыую дату, если нужно.
	Если ОбновитьДатуДвижения Тогда
		
		Если Не Движения.ОстаткиМатериалов.Выбран() И Не
			Движения.ОстаткиМатериалов.Модифицированность() Тогда
			Движения.ОстаткиМатериалов.Прочитать();
			
		КонецЕсли;
		
		Для Каждого ЗаписьРегистра Из Движения.ОстаткиМатериалов Цикл
			ЗаписьРегистра.Период = Дата;
			
		КонецЦикла; 
	
	КонецЕсли;
	

		КонецПроцедуры
